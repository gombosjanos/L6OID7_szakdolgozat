<template>
  <v-container fluid class="pa-4 has-bottom-bar">
    <v-toolbar density="comfortable" color="white" elevation="0" class="mb-3 detail-toolbar">
      <v-btn variant="elevated" color="primary" prepend-icon="mdi-arrow-left" @click="goBack">Vissza</v-btn>
      <v-toolbar-title>Munkalap #{{ displayId }}</v-toolbar-title>
      <v-spacer />
      <div class="d-flex align-center ga-2" style="margin-left:12px">
        <v-chip v-if="isRegistered && hasOffer" size="small" :color="offerStatusColor(offerStatus)" variant="tonal">{{ displayOfferStatus(offerStatus) }}</v-chip>
      </div>
      <v-chip size="small" :color="statusColorX(statusModel)" class="mr-2" variant="flat">{{ displayStatusX(statusModel) }}</v-chip>
    </v-toolbar>
    <v-row>
      <v-col cols="12" lg="6" class="left-col">
        <v-card class="mb-4">
          <v-card-title class="text-subtitle-1">Alap adatok</v-card-title>
          <v-divider />
          <v-card-text>            <div class="mb-2"><strong>Ugyfel:</strong> {{ getUgyfelNev(detail) }}</div>
            <div class="mb-2"><strong>E-mail:</strong> {{ getUgyfelEmail(detail) }}</div>
            <div class="mb-2"><strong>Telefon:</strong> {{ getUgyfelTelefon(detail) }}</div>
            <div class="mb-2"><strong>Felhasználónév:</strong> {{ getUgyfelFnev(detail) }}</div>
            <div class="mb-2"><strong>Gép:</strong> {{ gepLabel(gepFromRow(detail)) }}</div>
            <div class="mb-2"><strong>Létrehozva:</strong> {{ fmtDate(detail.letrehozva || detail.created_at) }}</div>
            <div class="mb-2"><strong>Azonosító:</strong> {{ displayId }}</div></v-card-text>
        </v-card>

    <v-alert v-if="errorMsg" type="error" variant="tonal" class="mb-3 detail-toolbar">{{ errorMsg }}</v-alert>
    <v-snackbar v-model="snackbar" :timeout="3000" :color="snackbarColor" location="top right">
      {{ snackbarText }}
      <template #actions>
        <v-btn variant="text" @click="snackbar = false">OK</v-btn>
      </template>
    </v-snackbar>

        <v-card class="mb-4" v-if="false">
          <v-card-title class="text-subtitle-1 d-flex align-center">
            <span>Kpek</span>
            <v-spacer />
            <template v-if="canManageImages">
              <v-btn
                color="primary"
                variant="tonal"
                size="small"
                prepend-icon="mdi-upload"
                :loading="uploadingImage"
                :disabled="uploadingImage"
                @click="triggerImageSelect"
              >
                Feltlts
              </v-btn>
            </template>
            <input
              ref="fileInput"
              type="file"
              accept="image/*"
              multiple
              class="d-none"
              @change="handleImageSelection"
            />
          </v-card-title>
          <v-divider />
          <v-card-text>            <div class="mb-2"><strong>Ugyfel:</strong> {{ getUgyfelNev(detail) }}</div>
            <div class="mb-2"><strong>E-mail:</strong> {{ getUgyfelEmail(detail) }}</div>
            <div class="mb-2"><strong>Telefon:</strong> {{ getUgyfelTelefon(detail) }}</div>
            <div class="mb-2"><strong>Felhasználónév:</strong> {{ getUgyfelFnev(detail) }}</div>
            <div class="mb-2"><strong>Gép:</strong> {{ gepLabel(gepFromRow(detail)) }}</div>
            <div class="mb-2"><strong>Létrehozva:</strong> {{ fmtDate(detail.letrehozva || detail.created_at) }}</div>
          </v-card-text>
        </v-card>

      
        <v-card>
          <v-card-title class="text-subtitle-1 d-flex align-center">
            <span>Napló</span>
            <v-spacer />
            <v-select
              v-model="statusModel"
              :items="statusItems"
              item-title="title"
              item-value="value"
              label="Státusz"
              variant="outlined"
              density="compact"
              style="max-width: 220px"
            />
          </v-card-title>
          <v-divider />
          <v-card-text>            <div class="mb-2"><strong>Ugyfel:</strong> {{ getUgyfelNev(detail) }}</div>
            <div class="mb-2"><strong>E-mail:</strong> {{ getUgyfelEmail(detail) }}</div>
            <div class="mb-2"><strong>Telefon:</strong> {{ getUgyfelTelefon(detail) }}</div>
            <div class="mb-2"><strong>Felhasználónév:</strong> {{ getUgyfelFnev(detail) }}</div>
            <div class="mb-2"><strong>Gép:</strong> {{ gepLabel(gepFromRow(detail)) }}</div>
            <div class="mb-2"><strong>Létrehozva:</strong> {{ fmtDate(detail.letrehozva || detail.created_at) }}</div>
            <div class="mb-2"><strong>Azonosító:</strong> {{ displayId }}</div></v-card-text>
        </v-card>
      </v-col>
      <v-col cols="12" lg="6">
        <v-card class="offer-card">
          <v-card-title class="d-flex align-center">
            <span class="text-subtitle-1">�raj�nlat</span>
            <v-spacer />
            <v-autocomplete
              v-model="pickerSelected"
              :items="pickerItems"
              :loading="pickerLoading"
              :search="pickerSearch"
              @update:search="onPickerSearch"
              @update:modelValue="onPickerSelect"
              item-title="label"
              item-value="value"
              return-object
              @focus="onPickerSearch('')"
              label="T�tel hozz�ad�sa"
              clear-on-select
              hide-details
              variant="outlined"
              density="comfortable"
              style="max-width: 420px"
              :disabled="!canEditOffer"
            />
          </v-card-title>

          <v-card-text>            <div class="mb-2"><strong>Ugyfel:</strong> {{ getUgyfelNev(detail) }}</div>
            <div class="mb-2"><strong>E-mail:</strong> {{ getUgyfelEmail(detail) }}</div>
            <div class="mb-2"><strong>Telefon:</strong> {{ getUgyfelTelefon(detail) }}</div>
            <div class="mb-2"><strong>Felhasználónév:</strong> {{ getUgyfelFnev(detail) }}</div>
            <div class="mb-2"><strong>Gép:</strong> {{ gepLabel(gepFromRow(detail)) }}</div>
            <div class="mb-2"><strong>Létrehozva:</strong> {{ fmtDate(detail.letrehozva || detail.created_at) }}</div>
            <div class="mb-2"><strong>Azonosító:</strong> {{ displayId }}</div></v-card-text>
        </v-card>
      </v-col>

      <v-col cols="12">
        <v-card class="mb-4">
          <v-card-title class="text-subtitle-1 d-flex align-center">
            <span>Kpek</span>
            <v-spacer />
            <template v-if="canManageImages">
              <v-btn color="primary" variant="tonal" size="small" prepend-icon="mdi-upload" :loading="uploadingImage" :disabled="uploadingImage" @click="triggerImageSelect">Feltlts</v-btn>
            </template>
            <input ref="fileInput" type="file" accept="image/*" multiple class="d-none" @change="handleImageSelection" />
          </v-card-title>
          <v-divider />
          <v-card-text>            <div class="mb-2"><strong>Ugyfel:</strong> {{ getUgyfelNev(detail) }}</div>
            <div class="mb-2"><strong>E-mail:</strong> {{ getUgyfelEmail(detail) }}</div>
            <div class="mb-2"><strong>Telefon:</strong> {{ getUgyfelTelefon(detail) }}</div>
            <div class="mb-2"><strong>Felhasználónév:</strong> {{ getUgyfelFnev(detail) }}</div>
            <div class="mb-2"><strong>Gép:</strong> {{ gepLabel(gepFromRow(detail)) }}</div>
            <div class="mb-2"><strong>Létrehozva:</strong> {{ fmtDate(detail.letrehozva || detail.created_at) }}</div>
            <div class="mb-2"><strong>Azonosító:</strong> {{ displayId }}</div></v-card-text>
                  <v-card-actions class="py-2 px-3">
                    <v-btn variant="text" size="small" color="primary" prepend-icon="mdi-magnify-plus" @click="openImageModal(img)">Nagyítás</v-btn>
                    <v-spacer />
                    <v-btn v-if="canManageImages" variant="text" size="small" color="error" prepend-icon="mdi-delete" @click="deleteImage(img)">T�rl�s</v-btn>
                  </v-card-actions>
                </v-card>
              </v-col>
            </v-row>
        

    <v-dialog v-model="lightboxOpen" fullscreen transition="dialog-bottom-transition">
      <v-card>
        <v-toolbar density="comfortable">
          <v-btn icon="mdi-close" @click="lightboxOpen = false" />
          <v-spacer />
          <v-btn icon="mdi-chevron-left" @click="prevImage" />
          <v-btn icon="mdi-chevron-right" @click="nextImage" />
        </v-toolbar>
        <v-card-text class="d-flex align-center justify-center">
          <img :src="lightboxUrl" alt="Kp" style="max-width:100%; max-height: calc(100vh - 64px);" />
        </v-card-text>
      </v-card>
    </v-dialog>

    <div class="detail-actions d-flex align-center justify-end ga-2">
      <v-btn class="action-btn" color="secondary" variant="elevated" prepend-icon="mdi-content-save" @click="saveWorkorder" :disabled="savingWorkorder" :loading="savingWorkorder">Munkalap mentse</v-btn>
      <v-btn class="action-btn" color="primary" variant="elevated" prepend-icon="mdi-content-save" @click="saveOffer" :disabled="savingOffer || !canEditOffer || hasShortage" :loading="savingOffer">�raj�nlat mentse</v-btn>
      <v-btn class="action-btn" color="grey" variant="elevated" prepend-icon="mdi-printer" @click="printOffer">Nyomtatás</v-btn>
      <v-btn class="action-btn" color="success" variant="elevated" prepend-icon="mdi-send" @click="sendOffer" :disabled="sendingOffer || !canSendOffer" :loading="sendingOffer">�raj�nlat kldse</v-btn>
      <v-btn v-if="isAdmin" class="action-btn" color="error" variant="elevated" prepend-icon="mdi-delete" @click="deleteWorkorder">T�rl�s</v-btn>
    </div>

    <div class="print-invoice">
      <div class="pi-header">
        <div class="pi-title">Árajánlat</div>
        <div class="pi-meta">
          <div>azonosito: {{ displayId }}</div>
          <div>gyfl: {{ getUgyfelNev(detail) }}</div>
          <div>Dtum: {{ fmtDate(detail.Létrehozva || detail.created_at) }}</div>
          <div>statusz: {{ displayStatus(detail.statusz || detail.status || detail.allapot) }}</div>
        </div>
      </div>
      <table class="pi-table">
        <thead>
          <tr>
            <th>Megnevezés</th>
            <th class="num">Db</th>
            <th class="num">Nettóó (Ft)</th>
            <th class="num">ÁFA%</th>
            <th class="num">Bruttóó (Ft)</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(t,i) in tetelek" :key="'p'+i">
            <td>{{ t.megnevezes }}</td>
            <td class="num">{{ t.db }}</td>
            <td class="num">{{ fmtCurrency(t.netto) }}</td>
            <td class="num">{{ t.afa_kulcs }}</td>
            <td class="num">{{ fmtCurrency(t.brutto) }}</td>
          </tr>
        </tbody>
      </table>
      <div class="pi-note" v-if="offerUzenet && offerUzenet.trim()">Megjegyzés: {{ offerUzenet }}</div>
    </div>
  </v-container>
</template>
<script setup>
import * as Vue from 'vue'
import { useRoute, useRouter, onBeforeRouteLeave } from 'vue-router'

async function request(path, { method = 'GET', body } = {}) {
  const url = `/api${path}`
  const headers = { 'Accept': 'application/json', 'Content-Type': 'application/json' }
  try { const tk = localStorage.getItem('auth_token') || localStorage.getItem('token') || localStorage.getItem('AUTH_TOKEN'); if (tk) headers['Authorization'] = `Bearer ${tk}` } catch {}
  const res = await fetch(url + (method === 'GET' && body ? `?${new URLSearchParams(body)}` : ''), { method, headers, body: method === 'GET' ? undefined : JSON.stringify(body ?? {}), credentials: 'include' })
  if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text().catch(() => '')}`)
  const ct = res.headers.get('content-type') || ''
  return ct.includes('application/json') ? res.json() : null
}

const route = useRoute()
const router = useRouter()
const id = Vue.computed(() => route.params.id)
const displayId = Vue.computed(()=> (detail.value && (detail.value.azonosito || detail.value.identifier)) || id.value)

const detail = Vue.ref({})
const naplo = Vue.ref([])
const note = Vue.ref('')
const tetelek = Vue.ref([])
const offer = Vue.ref(null)
const errorMsg = Vue.ref('')

const snackbar = Vue.ref(false)
const snackbarText = Vue.ref('')
const snackbarColor = Vue.ref('success')
function setSnack(text, color = 'success'){ snackbarText.value = text; snackbarColor.value = color; snackbar.value = true }

const offerUzenet = Vue.ref('')

const images = Vue.ref([])
const imagesLoading = Vue.ref(false)
const uploadingImage = Vue.ref(false)
const fileInput = Vue.ref(null)

const lightboxOpen = Vue.ref(false)
const lightboxUrl = Vue.ref('')
const currentIndex = Vue.ref(0)
const imgUrlCache = Vue.ref({})
const thumbPlaceholder = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="12"><rect width="100%" height="100%" fill="#f3f3f3"/></svg>'
function thumbSrc(img){ if (!img) return thumbPlaceholder; return imgUrlCache.value[img.id] || thumbPlaceholder }
async function getObjectUrl(img){ if (!img?.url || !img?.id) return ''; const cached = imgUrlCache.value[img.id]; if (cached) return cached; const headers = { }; try { const tk = localStorage.getItem('auth_token') || localStorage.getItem('token') || localStorage.getItem('AUTH_TOKEN'); if (tk) headers['Authorization'] = `Bearer ${tk}` } catch {}; const res = await fetch(img.url, { method: 'GET', headers, credentials: 'include' }); if(!res.ok){ throw new Error(`HTTP ${res.status}`) } const blob = await res.blob(); const objUrl = URL.createObjectURL(blob); imgUrlCache.value = { ...imgUrlCache.value, [img.id]: objUrl }; return objUrl }
async function openImageModal(img){ if (!img) return; try{ const idx = images.value.findIndex(i => (i.id ?? i.ID) === (img.id ?? img.ID)); currentIndex.value = idx >= 0 ? idx : 0; lightboxUrl.value = await getObjectUrl(img); lightboxOpen.value = true }catch(e){ setSnack('Kp Nagyítása nem sikerlt.', 'error') } }
async function showAt(index){ if (images.value.length === 0) return; const len = images.value.length; const i = ((index % len) + len) % len; currentIndex.value = i; const img = images.value[i]; try{ lightboxUrl.value = await getObjectUrl(img) }catch(e){} }
function prevImage(){ showAt(currentIndex.value - 1) }
function nextImage(){ showAt(currentIndex.value + 1) }
Vue.watch(images, (list)=>{ try{ (Array.isArray(list)?list:[]).forEach(it => { getObjectUrl(it).catch(()=>{}) }) }catch{} }, { immediate: true })

const statusItems = [
  { title: 'j', value: 'uj' },
  { title: 'Folyamatban', value: 'folyamatban' },
  { title: '�raj�nlat elküldve', value: 'ajanlat_elkuldve' },
  { title: 'Alkatrszre vr', value: 'alkatreszre_var' },
  { title: 'Javts ksz', value: 'javitas_kesz' },
  { title: '�raj�nlat elutastva', value: 'ajanlat_elutasitva' },
  { title: 'tadva/Lezrva', value: 'atadva_lezarva' },
  { title: '�raj�nlat elfogadva', value: 'ajanlat_elfogadva' },
]
const originalStatus = Vue.ref('')
function normalizeStatus(s){ const t=(s||'').toString().toLowerCase(); const n=t.normalize('NFD').replace(/[\u0300-\u036f]/g,''); if(n.includes('uj')) return 'uj'; if(n.includes('folyamatban')) return 'folyamatban'; if(n.includes('elkuldve')) return 'ajanlat_elkuldve'; if(n.includes('var')) return 'alkatreszre_var'; if(n.includes('kesz')) return 'javitas_kesz'; if(n.includes('elutasit')) return 'ajanlat_elutasitva'; if(n.includes('atadva') || n.includes('lezarva')) return 'atadva_lezarva'; if(n.includes('elfogad')) return 'ajanlat_elfogadva'; return t }
const statusModel = Vue.computed({ get(){ return normalizeStatus(detail.value.statusz || detail.value.status || detail.value.allapot) }, set(v){ detail.value.statusz = v } })
function statusColorX(s){ switch(normalizeStatus(s)){ case 'uj': return 'grey'; case 'folyamatban': return 'blue'; case 'ajanlat_elkuldve': return 'purple'; case 'alkatreszre_var': return 'orange'; case 'javitas_kesz': return 'green'; case 'ajanlat_elfogadva': return 'indigo'; case 'atadva_lezarva': return 'teal'; case 'ajanlat_elutasitva': return 'red'; default: return 'grey' } }
function displayStatusX(s){ const key=normalizeStatus(s); const map={ 'uj':'j','folyamatban':'Folyamatban','ajanlat_elkuldve':'�raj�nlat elküldve','alkatreszre_var':'Alkatrszre vr','javitas_kesz':'Javts ksz','ajanlat_elutasitva':'�raj�nlat elutastva','atadva_lezarva':'tadva/Lezrva','ajanlat_elfogadva':'�raj�nlat elfogadva', }; return map[key] || s || '-' }
const statusOptions = ['j','Folyamatban','�raj�nlat elküldve','Alkatrszre vr','Javts ksz','�raj�nlat elutastva','tadva/Lezrva','�raj�nlat elfogadva']
function fmtDate(v){ try { return v ? new Date(v).toLocaleString('hu-HU') : '' } catch { return v || '' } }
function fmtCurrency(v){ if (v==null||v==='') return ''; return new Intl.NumberFormat('hu-HU',{style:'currency',currency:'HUF',maximumFractionDigits:0}).format(Number(v)) }
function statusColor(s){ const k=(s||'').toLowerCase(); switch(k){ case 'j': case 'uj': return 'grey'; case 'folyamatban': return 'blue'; case '�raj�nlat elküldve': case 'ajanlat_elkuldve': return 'purple'; case 'alkatrszre vr': case 'alkatreszre_var': return 'orange'; case 'javts ksz': case 'javitas_kesz': return 'green'; case '�raj�nlat elfogadva': case 'ajanlat_elfogadva': return 'indigo'; case 'tadva/lezrva': case 'atadva': case 'lezarva': case 'atadva_lezarva': return 'teal'; case '�raj�nlat elutastva': case 'ajanlat_elutasitva': return 'red'; default: return 'grey' } }
function displayStatus(s){ const key=(s||'').toLowerCase(); const map={ 'j':'j','uj':'j','folyamatban':'Folyamatban','�raj�nlat elküldve':'�raj�nlat elküldve','ajanlat_elkuldve':'�raj�nlat elküldve','alkatrszre vr':'Alkatrszre vr','alkatreszre_var':'Alkatrszre vr','javts ksz':'Javts ksz','javitas_kesz':'Javts ksz','�raj�nlat elutastva':'�raj�nlat elutastva','ajanlat_elutasitva':'�raj�nlat elutastva','tadva/lezrva':'tadva/Lezrva','atadva':'tadva/Lezrva','lezarva':'tadva/Lezrva','atadva_lezarva':'tadva/Lezrva','�raj�nlat elfogadva':'�raj�nlat elfogadva','ajanlat_elfogadva':'�raj�nlat elfogadva', }; return map[key] || s || '-' }
function GépFromRow(row){ if(row?.Gép) return row.Gép; if(row?.Gép_adatok) return row.Gép_adatok; const gyarto=row?.gyarto||row?.Gép_gyarto; const tipusnev=row?.tipusnev||row?.Gép_tipus; const g_cikkszam=row?.g_cikkszam||row?.cikkszam||row?.Gép_cikkszam; if(gyarto||tipusnev||g_cikkszam) return {gyarto,tipusnev,g_cikkszam}; return null }
function GépLabel(Gép){ if(!Gép) return '-'; try{ const gyarto = Gép.gyarto || Gép.Gép_gyarto || ''; const tipus = Gép.tipusnev || Gép.Gép_tipus || ''; const cikkszam = Gép.g_cikkszam || Gép.cikkszam || Gép.Gép_cikkszam || ''; const head = [gyarto, tipus].filter(Boolean).join(' '); return [head, cikkszam].filter(Boolean).join(' - ') }catch{ return '-' } }
function getUgyfelNev(row){ try{ return row?.Ugyfel?.nev ?? row?.Ugyfel_nev ?? row?.nev ?? row?.Ugyfel_adatok?.nev ?? '-' }catch{ return '-' } }
function getUgyfelEmail(row){ try{ return row?.Ugyfel?.email ?? row?.Ugyfel_email ?? row?.email ?? '-' }catch{ return '-' } }
function getUgyfelTelefon(row){ try{ return row?.Ugyfel?.telefonszam ?? row?.Ugyfel_telefon ?? row?.telefonszam ?? '-' }catch{ return '-' } }
function getUgyfelFnev(row){ try{ return row?.Ugyfel?.Felhasználónév ?? row?.Felhasználónév ?? '-' }catch{ return '-' } }
function parseNum(v){ if (typeof v === 'number') return isFinite(v)?v:0; if (v==null) return 0; const s=String(v).replace(/\s+/g,'').replace(',', '.'); const n=parseFloat(s); return isFinite(n)?n:0 }

function normalizeImageEntry(entry, index = 0){ if(!entry) return null; const id = entry.id ?? entry.ID ?? entry.kep_id ?? null; const relative = entry.fajlnev || entry.path || ''; const url = entry.url || (relative ? `/storage/${relative.replace(/^\/+/, '')}` : ''); return { ...entry, id, url, _key: id ?? `${relative || 'image'}-${index}-${entry.Létrehozva ?? Date.now()}` } }
function normalizeImageList(list){ return (Array.isArray(list) ? list : []).map((item, idx) => normalizeImageEntry(item, idx)).filter(Boolean) }
const hasImages = Vue.computed(()=> images.value.length > 0)
function formatFileSize(size){ const bytes = Number(size); if (!bytes || Number.isNaN(bytes)) return ''; const units = ['B','KB','MB','GB']; let value = bytes; let unitIndex = 0; while (value >= 1024 && unitIndex < units.length - 1){ value /= 1024; unitIndex += 1 } const fixed = unitIndex === 0 ? Math.round(value) : value.toFixed(1); return `${fixed} ${units[unitIndex]}` }
async function fetchImages(silent = false){ if(!id.value) return; const showSpinner = !silent && images.value.length === 0; if(showSpinner) imagesLoading.value = true; try{ const data = await request(`/munkalapok/${id.value}/kepek`); images.value = normalizeImageList(data); try{ const first = images.value.slice(0,8); for (const it of first){ getObjectUrl(it).catch(()=>{}) } }catch{} }catch(e){ if(!silent){ setSnack(e?.message || 'Kpek betltse nem sikerlt.', 'error') } }finally{ if(showSpinner) imagesLoading.value = false } }
function triggerImageSelect(){ fileInput.value?.click?.() }
async function handleImageSelection(event){ const files = Array.from(event?.target?.files || []); event.target.value = ''; if (!files.length || !id.value){ return } uploadingImage.value = true; try { const formData = new FormData(); for (const file of files){ formData.append('kepek[]', file) } const headers = { Accept: 'application/json' }; try { const token = localStorage.getItem('auth_token') || localStorage.getItem('token') || localStorage.getItem('AUTH_TOKEN'); if (token) headers.Authorization = `Bearer ${token}` } catch {} const res = await fetch(`/api/munkalapok/${id.value}/kepek`, { method: 'POST', headers, body: formData, credentials: 'include' }); if (!res.ok){ const text = await res.text().catch(() => ''); throw new Error(text || 'Feltltsi hiba trtnt.') } const payload = await res.json().catch(() => ({})); const added = normalizeImageList(payload?.kepek ?? payload ?? []); images.value = [...added, ...images.value]; setSnack('Kpek feltltve') } catch (e) { setSnack(e?.message || 'A kpfeltlts nem sikerlt.', 'error') } finally { uploadingImage.value = false } }
async function deleteImage(img){ if(!img || !id.value) return; const imageId = img.id ?? img.ID; if(!imageId) return; if(!confirm('Biztosan trld ezt a kpet?')) return; try{ const headers = { Accept: 'application/json' }; try { const token = localStorage.getItem('auth_token') || localStorage.getItem('token') || localStorage.getItem('AUTH_TOKEN'); if (token) headers.Authorization = `Bearer ${token}` } catch {} const res = await fetch(`/api/munkalapok/${id.value}/kepek/${imageId}`, { method: 'DELETE', headers, credentials: 'include' }); if (!res.ok){ const text = await res.text().catch(() => ''); throw new Error(text || 'Nem sikerlt trlni a kpet.') } images.value = images.value.filter(item => (item.id ?? item.ID) !== imageId); setSnack('Kp trlve', 'success') }catch(e){ setSnack(e?.message || 'Nem sikerlt trlni a kpet.', 'error') } }

const partStockById = Vue.ref({})
const partNameSet = new Set()
async function preloadPartsIndex(){ try{ const res = await request('/alkatreszek', { method: 'GET', body: { q: '', limit: '1000' } }); const arr = Array.isArray(res) ? res : []; for(const p of arr){ const nm = p.alkatresznev ?? p.alaktresznev ?? p.nev ?? p.megnevezes; if(nm) partNameSet.add(norm(nm)); const pid = p.ID ?? p.id; if(pid!=null) partStockById.value[pid] = p.keszlet ?? 0 } }catch{} }
function norm(s){ try{ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'') }catch{ return (s||'').toString().toLowerCase() } }
function isKnownPartName(name){ if(!name) return false; return partNameSet.has(norm(name)) }
async function loadAll(){ try{ await preloadPartsIndex(); const d = await request(`/munkalapok/${id.value}`); detail.value = d || {}; images.value = normalizeImageList(detail.value?.kepek); await fetchImages(true); const s = normalizeStatus(detail.value.statusz || detail.value.status || detail.value.allapot); originalStatus.value = s; statusModel.value = s; const n = await request(`/munkalapok/${id.value}/naplo`); naplo.value = Array.isArray(n)?n:[]; const a = await request(`/munkalapok/${id.value}/ajanlat`); offer.value = a || null; await applyAjanlat(a) }catch(e){ errorMsg.value = e?.message || 'Betöltési hiba.' } }
async function applyAjanlat(a){ const rows = a?.tetelek || []; try{ offerUzenet.value = (a?.megjegyzes || '').toString() }catch{}; tetelek.value = rows.map(r => { const tNorm = norm(r?.tipus); const name = r?.megnevezes || r?.alaktresznev || r?.alkatresznev || ''; const nameNorm = norm(name); const isPart = tNorm.includes('alkatresz') || !!(r?.alkatresz_id || r?.a_cikkszam || r?.cikkszam || r?.alkatresznev || r?.alaktresznev) || isKnownPartName(name); const isMunkadij = tNorm.includes('munkadij') || nameNorm.includes('munkadij'); const tipus = isPart ? 'alkatresz' : (isMunkadij ? 'munkadij' : 'egyedi'); const db = parseNum(r?.mennyiseg ?? r?.db ?? 1) || 1; const netto = parseNum(r?.netto_egyseg_ar ?? r?.netto ?? r?.nettoar ?? r?.netto_ar ?? r?.egyseg_ar ?? 0); let brutto = parseNum(r?.brutto_egyseg_ar ?? r?.brutto ?? r?.bruttoar ?? r?.brutto_ar ?? 0); if(!brutto){ const osszeg = parseNum(r?.osszeg ?? 0); if(osszeg && db){ brutto = osszeg / db } } const afa = parseNum(r?.afa_kulcs ?? r?.afa ?? 27); const pid = r?.alkatresz_id || null; const keszlet = pid ? (partStockById.value?.[pid] ?? 0) : 0; return { tipus, alkatresz_id: pid, megnevezes: name, db, netto, brutto, afa_kulcs: afa, keszlet } }) }
function syncOfferStocks(){ try{ tetelek.value = (tetelek.value||[]).map(t=> t?.alkatresz_id ? ({...t, keszlet: (partStockById.value?.[t.alkatresz_id] ?? t.keszlet ?? 0) }) : t) }catch{} }
const totalNetto = Vue.computed(()=>tetelek.value.reduce((s,t)=>s+((Number(t.netto)||0)*(Number(t.db)||1)),0))
const totalBrutto = Vue.computed(()=>tetelek.value.reduce((s,t)=>s+((Number(t.brutto)||0)*(Number(t.db)||1)),0))
const demandMap = Vue.computed(()=>{ const m={}; for(const t of (tetelek.value||[])){ const pid=t?.alkatresz_id; if(!pid) continue; const qty=Number(t?.db||0) || 0; m[pid]=(m[pid]||0)+qty } return m })
function stockFor(pid){ return pid ? (partStockById.value?.[pid] ?? 0) : 0 }
function shortageAtIndex(i){ const t=(tetelek.value||[])[i]; if(!t||!t.alkatresz_id) return false; const need=demandMap.value[t.alkatresz_id]||0; const have=stockFor(t.alkatresz_id); return need>have }
const hasShortage = Vue.computed(()=>{ const items=tetelek.value||[]; for(let i=0;i<items.length;i++){ if(shortageAtIndex(i)) return true } return false })
function removeTetel(i){ if(!canEditOffer.value) return; tetelek.value.splice(i,1) }
function numStyle(val, minCh = 8, maxCh = 24){ const len = String(val ?? '').length || 1; const ch = Math.min(Math.max(len + 2, minCh), maxCh); return { '--w': ch + 'ch' } }
function nameLocked(t){ if (offerLocked.value) return true; const typ = (t?.tipus || '').toString().toLowerCase(); if (typ && typ !== 'egyedi') return true; if (t?.alkatresz_id) return true; if (isKnownPartName(t?.megnevezes)) return true; return false }

const savingWorkorder = Vue.ref(false)
const savingOffer = Vue.ref(false)
const sendingOffer = Vue.ref(false)
const workDirty = Vue.ref(false)
const offerDirty = Vue.ref(false)
const hydrating = Vue.ref(true)
const userRole = Vue.computed(()=>{ try{ const u = JSON.parse(localStorage.getItem('user')||'null'); return (u?.jogosultsag || localStorage.getItem('jogosultsag') || localStorage.getItem('role') || '').toString().toLowerCase() }catch{ return '' } })
const isAdmin = Vue.computed(()=> userRole.value === 'admin')
const isSzerelo = Vue.computed(()=> userRole.value === 'szerelo')
const canManageImages = Vue.computed(()=> isAdmin.value || isSzerelo.value)
async function deleteWorkorder(){ if(!isAdmin.value || !id.value) return; if(!confirm('Biztosan trli a munkalapot?')) return; try{ await request(`/munkalapok/${id.value}`, { method: 'DELETE' }); setSnack('Munkalap trlve', 'success'); router.push('/admin/munkalapok') }catch(e){ errorMsg.value = e?.message || 'T�rl�s sikertelen.' } }
function buildOfferPayload(){ return { megjegyzes: (offerUzenet.value && offerUzenet.value.trim()) ? offerUzenet.value.trim() : null, tetelek: (tetelek.value||[]).map(t=>({ id: t.id ?? undefined, tipus: t.tipus, alkatresz_id: t.alkatresz_id ?? null, megnevezes: t.megnevezes, mennyiseg: (t.db || 1), netto_egyseg_ar: t.netto ?? 0, brutto_egyseg_ar: t.brutto ?? 0, afa_kulcs: t.afa_kulcs ?? 27, })) } }
function validateOffer(){ if(!Array.isArray(tetelek.value)){ return { ok: false, msg:'Nincs ttel az �raj�nlatban.' } } for(let i=0;i<tetelek.value.length;i++){ const t=tetelek.value[i]; if(!String(t?.megnevezes||'').trim()) return { ok: false, msg:`Hinyz Megnevezés a(z) ${i+1}. sorban.` }; const db=Number(t?.db ?? 0); if(!isFinite(db)||db<1) return { ok: false, msg:`rvnytelen darabszm a(z) ${i+1}. sorban.` }; const netto=Number(t?.netto ?? 0), brutto=Number(t?.brutto ?? 0); if(!isFinite(netto) || !isFinite(brutto)) return { ok: false, msg:`rvnytelen r a(z) ${i+1}. sorban.` } } return { ok:true } }
async function saveOffer(){ if(!id.value) return; try{ const valid = validateOffer(); if(!valid.ok){ setSnack(valid.msg || 'rvnytelen �raj�nlat.', 'error'); return } savingOffer.value=true; await request(`/munkalapok/${id.value}/ajanlat`,{method:'POST',body:buildOfferPayload()}); const a=await request(`/munkalapok/${id.value}/ajanlat`); offer.value=a||null; offerDirty.value=false; setSnack('�raj�nlat mentve') }catch(e){ errorMsg.value=e?.message||'Mentési hiba (�raj�nlat).' } finally{ savingOffer.value=false } }
async function sendOffer(){ if(!id.value) return; try{ if(!confirm('Biztosan elkldi az �raj�nlatot az gyflnek? A klds utn nem mdosthat.')) return; sendingOffer.value=true; await saveOffer(); await request(`/munkalapok/${id.value}/ajanlat`,{method:'POST',body:{ statusz: 'elkuldve' }}); try { await request(`/munkalapok/${id.value}`, { method:'PATCH', body:{ statusz: 'ajanlat_elkuldve' } }); detail.value.statusz = 'ajanlat_elkuldve' } catch {} const a=await request(`/munkalapok/${id.value}/ajanlat`); offer.value=a||null; setSnack('�raj�nlat elküldve') }catch(e){ errorMsg.value=e?.message||'Kldsi hiba (�raj�nlat).' } finally{ sendingOffer.value=false } }
const hasOffer = Vue.computed(()=>!!(offer.value && ((offer.value.id)||(Array.isArray(offer.value.tetelek)&&offer.value.tetelek.length>0))))
const offerSent = Vue.computed(()=>{ const o=offer.value||{}; const s=(o.statusz||'').toLowerCase(); return !!(o.elkuldve===true || o.elkuldve_at || s==='elkuldve') })
const offerLocked = Vue.computed(()=>{ const o=offer.value||{}; const s=(o.statusz||'').toLowerCase(); return s==='elkuldve' || s==='elfogadva' || s==='elutasitva' || o.elkuldve===true || !!o.elkuldve_at })
const canEditOffer = Vue.computed(()=>!offerLocked.value)
const canSendOffer = Vue.computed(()=>!offerLocked.value && tetelek.value.length>0 && !hasShortage.value)
const isRegistered = Vue.computed(()=>{ const d=detail.value||{}; try{ return !!(d.user_id || d.Ugyfel?.id || d.Ugyfel_id) }catch{ return false } })
const offerStatus = Vue.computed(()=> (offer.value?.statusz || '').toString().toLowerCase())
function offerStatusColor(s){ switch((s||'').toLowerCase()){ case 'elkuldve': return 'orange'; case 'elfogadva': return 'green'; case 'elutasitva': return 'red'; default: return 'grey' } }
function displayOfferStatus(s){ const k=(s||'').toLowerCase(); const map={ elkuldve:'Elfogadsra vr', elfogadva:'Elfogadva', elutasitva:'Elutastva' }; return map[k]||'-' }
const processingOffer = Vue.ref(false)
async function setOfferStatus(code){ if(!id.value) return; try{ processingOffer.value=true; await request(`/munkalapok/${id.value}/ajanlat`,{method:'POST',body:{statusz:code}}); const a=await request(`/munkalapok/${id.value}/ajanlat`); offer.value=a||null; setSnack(displayOfferStatus(code)) }catch(e){ errorMsg.value=e?.message||'�raj�nlat statusz frisstsi hiba.' } finally{ processingOffer.value=false } }
function acceptOffer(){ setOfferStatus('elfogadva') }
function rejectOffer(){ setOfferStatus('elutasitva') }
function goBack(){ try{ if(window.history && window.history.length>1) router.back(); else router.push('/admin/munkalapok') } catch{} }
function printOffer(){ try{ window.print() }catch{} }
const pickerSelected = Vue.ref(null)
const pickerSearch = Vue.ref('')
const pickerItems = Vue.ref([{ label:'Munkadj', value:'munkadij' },{ label:'Egyedi ttel', value:'egyedi' },])
const pickerLoading = Vue.ref(false)
async function onPickerSearch(val){ pickerSearch.value = val; try{ pickerLoading.value = true; const res = await request('/alkatreszek', { method: 'GET', body: { q: val || '', limit: '20' } }); const partItems = (Array.isArray(res) ? res : []).map(p => { const id = p.ID ?? p.id; const name = (p.alkatresznev ?? p.alaktresznev ?? p.nev ?? p.megnevezes) || 'Alkatrsz'; const code = p.a_cikkszam ?? p.cikkszam ?? p.code ?? ''; return { label: code ? `${name} (${code})` : name, value: { id, name } } }); pickerItems.value = [{ label:'Munkadj', value:'munkadij' },{ label:'Egyedi ttel', value:'egyedi' }, ...partItems ] }finally{ pickerLoading.value = false } }
async function onPickerSelect(opt){ if(!opt) return; if(typeof opt.value === 'string'){ if(opt.value === 'munkadij'){ tetelek.value.push({ tipus:'munkadij', megnevezes:'Munkadj', db:1, netto:0, brutto:0, afa_kulcs:27 }) } else if (opt.value === 'egyedi'){ tetelek.value.push({ tipus:'egyedi', megnevezes:'Egyedi ttel', db:1, netto:0, brutto:0, afa_kulcs:27 }) } } else if (opt.value && typeof opt.value === 'object'){ const v = opt.value; tetelek.value.push({ tipus:'alkatresz', alkatresz_id: v.id, megnevezes: (v.name || 'Alkatrsz'), db: 1, netto: 0, brutto: 0, afa_kulcs: 27 }) } pickerSelected.value = null; try{ syncOfferStocks() }catch{} }
async function saveWorkorder(){ if(!id.value) return; try{ savingWorkorder.value = true; const code = normalizeStatus(detail.value.statusz); if (code === normalizeStatus(originalStatus.value)) { setSnack('Nincs változás'); return } await request(`/munkalapok/${id.value}`, { method:'PATCH', body:{ statusz: code, status: code, allapot: code } }); workDirty.value = false; originalStatus.value = code; setSnack('Munkalap mentve') }catch(e){ errorMsg.value = e?.message || 'Mentési hiba (munkalap).' }finally{ savingWorkorder.value = false } }
Vue.onMounted(loadAll)
Vue.watch(()=>detail.value.statusz, ()=>{ if(!hydrating.value) workDirty.value = normalizeStatus(detail.value.statusz) !== normalizeStatus(originalStatus.value) })
Vue.watch(tetelek, ()=>{ if(!hydrating.value) offerDirty.value = true }, { deep: true })
Vue.watch(()=>offerUzenet.value, ()=>{ if(!hydrating.value) offerDirty.value = true })
onBeforeRouteLeave((to,from,next)=>{ if(workDirty.value||offerDirty.value){ if(confirm('Vannak nem mentett vltoztatsok. Biztosan kilpsz?')) next(); else next(false) } else next() })
if(typeof window !== 'undefined'){ window.addEventListener('beforeunload', (e)=>{ if(workDirty.value||offerDirty.value){ e.preventDefault(); e.returnValue=''; } }) }

function noteRaw(n){ try{ return (n?.uzenet ?? n?.szoveg ?? n?.megjegyzes ?? '').toString() }catch{ return '' } }
function normalizeNewlines(s){ if (s == null) return ''; let t = String(s); t = t.replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n'); t = t.replace(/\r\n/g, '\n').replace(/\r/g, '\n'); return t }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;') }
function formatNoteHtml(n){ const raw = normalizeNewlines(noteRaw(n)); return escapeHtml(raw).replace(/\n/g, '<br>') }
function noteId(n){ return n?.id ?? n?.ID }
async function editNote(n){ const idVal = noteId(n); if(!id.value || !idVal) return; const current = (n?.uzenet || n?.szoveg || n?.megjegyzes || "").toString(); const next = window.prompt("Jegyzet Szerkeszt�se:", current); if(next==null) return; try{ await request(`/munkalapok/${id.value}/naplo/${idVal}`, { method:"PATCH", body:{ uzenet: next } }); n.uzenet = next }catch(e){ setSnack(e?.message||"Szerkeszt�s nem sikerlt","error") } }
async function deleteNote(n){ const idVal = noteId(n); if(!id.value || !idVal) return; if(!window.confirm("Biztosan trld ezt a bejegyzst?")) return; try{ await request(`/munkalapok/${id.value}/naplo/${idVal}`, { method:"DELETE" }); naplo.value = naplo.value.filter(x=> noteId(x)!==idVal) }catch(e){ setSnack(e?.message||"T�rl�s nem sikerlt","error") } }
</script>
<style scoped>
.detail-actions{ position: sticky; bottom: 0; left:0; right:0; z-index: 8; background:#fff; border-top:1px solid #eee; padding: 10px 12px; display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; margin-top:16px; }
.has-bottom-bar{ min-height: 100vh; padding-bottom: 120px; overflow-y: auto; }
.num-input:deep(input){ text-align: right; font-weight: 600; color: #111; width: var(--w, 12ch); }
.name-input:deep(.v-field){ min-width: 260px; }
:deep(.v-btn:not(.v-btn--icon)) { text-align: center; }
:deep(.v-btn:not(.v-btn--icon) .v-btn__content) { justify-content: center; width: 100%; }
.offer-scroll{ overflow-x: auto; overflow-y: auto; max-height: 60vh; }
.offer-scroll::-webkit-scrollbar{ width: 8px; height: 8px; }
.offer-scroll::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.25); border-radius: 4px; }
.offer-scroll::-webkit-scrollbar-track{ background: transparent; }
.offer-scroll .v-table{ min-width: 780px; table-layout: fixed; }
.offer-scroll .v-table th:nth-child(1),
.offer-scroll .v-table td:nth-child(1){ width: 48%; }
.offer-scroll .v-table th:nth-child(2),
.offer-scroll .v-table td:nth-child(2){ width: 10%; }
.offer-scroll .v-table th:nth-child(3),
.offer-scroll .v-table td:nth-child(3){ width: 16%; }
.offer-scroll .v-table th:nth-child(4),
.offer-scroll .v-table td:nth-child(4){ width: 10%; }
.offer-scroll .v-table th:nth-child(5),
.offer-scroll .v-table td:nth-child(5){ width: 16%; }
.offer-scroll .v-table th:nth-child(6),
.offer-scroll .v-table td:nth-child(6){ width: 12%; }
.offer-scroll .v-table td:nth-child(1) .name-input{ width: 100%; }
.offer-scroll .v-table td:nth-child(1) .name-input:deep(.v-field){ width: 100%; }
.offer-scroll .v-table td:nth-child(1) .name-input:deep(.v-field__field){ padding-right: 12px; }
.offer-scroll .v-table td:nth-child(2){ padding-left: 12px; }
.num-text{ text-align:right; font-weight:600; color:#111; }
.image-card{ overflow:hidden; border-radius:12px; }
.image-card .v-img{ background:#f5f5f5; }
.image-card .image-meta{ background:rgba(0,0,0,0.02); min-height:48px; }
.image-card .text-truncate{ max-width:100%; }
.image-card .v-card-actions{ background:rgba(0,0,0,0.01); display:flex; align-items:center; justify-content:space-between; gap:8px; }
.cursor-pointer{ cursor:pointer; }
.note-text{ white-space: normal; line-height: 1.35; word-break: break-word; }
/* Images grid responsive tweaks */
@media (max-width: 600px){
  .images-grid{ flex-wrap: nowrap !important; overflow-x: auto; padding-bottom: 4px; margin-bottom: -4px; scroll-snap-type: x mandatory; }
  .images-grid > .v-col{ flex: 0 0 80% !important; max-width: 80% !important; scroll-snap-align: start; }
}
@media (max-width: 600px){
  .detail-toolbar{ flex-wrap: wrap; }
  .detail-toolbar .v-toolbar-title{ flex:1 0 100%; }
  .detail-actions{ position: sticky; bottom: 0; box-shadow: 0 -6px 16px rgba(0,0,0,.08); padding: 8px 12px max(12px, env(safe-area-inset-bottom)); flex-direction: column; align-items: stretch; justify-content: center; gap: 8px; }
  .has-bottom-bar{ padding-bottom: 160px; }
}
.detail-actions .v-btn.action-btn{ min-width: 128px; font-weight:600; }
@media (max-width: 600px){ .detail-actions .v-btn.action-btn{ width: 100%; min-width: unset; height: 40px; font-size: 0.88rem; padding-inline: 12px; } }
@media (max-width: 380px){ .detail-actions .v-btn.action-btn{ flex-basis: 100%; } .offer-scroll{ max-height: 50vh; } }
.print-invoice{ display:none; font-family: Arial, "Segoe UI", "DejaVu Sans", sans-serif; color:#000; }
.print-invoice .pi-title{ font-size:20px; font-weight:700; margin-bottom:6px; }
.print-invoice .pi-meta{ font-size:12px; margin-bottom:10px; }
.print-invoice .pi-table{ width:100%; border-collapse:collapse; font-size:12px; }
.print-invoice .pi-table th, .print-invoice .pi-table td{ border:1px solid #333; padding:6px 8px; }
.print-invoice .pi-table th{ background:#f3f3f3; text-align:left; }
.print-invoice .num{ text-align:right; }
.print-invoice .right{ text-align:right; }
.print-invoice .pi-note{ margin-top:10px; font-size:12px; }
@media print{ .detail-toolbar, .detail-actions, .v-alert, .v-snackbar{ display:none !important; } .left-col{ display:none !important; } .offer-card{ box-shadow:none !important; border:none !important; } .has-bottom-bar{ padding-bottom:0 !important; } .print-invoice{ display:block !important; } }
</style>




















